# 微信开发者服务器验证

### 概述

接入微信公众平台开发，开发者需要按照如下步骤完成：

- 填写服务器配置
- 验证服务器地址的有效性
- 依据接口文档实现业务逻辑
- [官方指南文档](https://mp.weixin.qq.com/wiki?t=resource/res_main&id=mp1421135319)

具体实现代码如下：

```java
/**
 * @author ：CBL
 * @date ：Created in 2020/1/7  20:41
 * @description：
 */
@Api(tags = "微信小程序消息推送API")
@RestController
@RequestMapping(value = "/wx/mini/message/push",produces = "application/json;charset=UTF-8")
public class WxminiMessagePushApi {

    private static final Logger logger = LoggerFactory.getLogger(WxminiMessagePushApi.class);


    @Autowired
    private WxMiniSendCustomerServiceMessageComponent customerServiceMessageComponent;

    @Value("${wxmini.appId}")
    private String appId;

    @Value("${wxmini.accessToken}")
    private  String accessToken;

    @Value("${wxmini.encodingAesKey}")
    private  String encodingAesKey;


    @ApiOperation("验证消息的确来自微信服务器")
    @GetMapping(value = "/check" )
    public void checkSign(HttpServletRequest request, HttpServletResponse response) {
        logger.info("token校验接口");
        try {
            String signature = request.getParameter("signature");
            // 时间戳
            String timestamp = request.getParameter("timestamp");
            // 随机数
            String nonce = request.getParameter("nonce");
            // 随机字符串  
            String echostr = request.getParameter("echostr");

            logger.info("验证消息的确来自微信服务器参数为:{},{},{},{}",signature,timestamp,nonce,echostr);
            List<String> list=new ArrayList();
            list.add(accessToken);
            list.add(timestamp);
            list.add(nonce);

            Collections.sort(list);
            String s="";
            for (String str : list) {
                s+=str;
            }
            String result = DigestUtils.sha1Hex(s);
            if (signature.equals(result)) {
                logger.info("校验通过");
                response.getOutputStream().println(echostr);
            }
            logger.info("校验不通过");
        }catch (Exception e){
            logger.error("验证消息的确来自微信服务器异常");
        }
    }

    @ApiOperation("接收微信推送的消息")
    @PostMapping(value = "/check" )
    public void getMessage(HttpServletResponse response, WxMiniPushMessageDTO wxMiniPushMessageDTO , @RequestBody String requestBody)throws Exception {
        logger.info("收消息接口：{}",requestBody);

        WXBizMsgCrypt pc = new WXBizMsgCrypt(accessToken, encodingAesKey, appId);
        String str=pc.decryptMsg(wxMiniPushMessageDTO.getMsg_signature(), wxMiniPushMessageDTO.getTimestamp(), wxMiniPushMessageDTO.getNonce(), requestBody);
        String openId=wxMiniPushMessageDTO.getOpenid();
        //收到消息体
        JSONObject jsonObject = JSON.parseObject(requestBody);
        String msgType = jsonObject.getString("MsgType");
        String event = jsonObject.getString("Event");
        //业务逻辑处理.....
        response.getOutputStream().println("success");
    }
```

说明：

1. 代码里面的WXBizMsgCrypt类在微信提供的demo中存在。
2. 两个方法的请求路径相同，一个是验证是get请求，post为服务器转发的消息。